# å¹¿å‘Šæ‹¦æˆªè§„åˆ™è‡ªåŠ¨æ›´æ–°å·¥ä½œæµ
# ç‰ˆæœ¬: 1.0.0
# åŠŸèƒ½: æ¯æ—¥è‡ªåŠ¨ä¸‹è½½ã€å¤„ç†å¹¶æäº¤å¹¿å‘Šæ‹¦æˆªè§„åˆ™
# è§¦å‘æ–¹å¼:
#   1. å®šæ—¶ä»»åŠ¡: æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œ
#   2. æ‰‹åŠ¨è§¦å‘: åœ¨ Actions é¡µé¢ç‚¹å‡» "Run workflow"
# 
# ç”Ÿæˆæ–‡ä»¶: adblock.txt, reports.txt, README.md

name: è§„åˆ™è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥å‡Œæ™¨2ç‚¹
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1
          clean: true

      - name: ç½‘ç»œæºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ~/.cache/adblock-sources
          key: sources-${{ hashFiles('sources.txt') }}
          restore-keys: |
            sources-

      - name: ç¯å¢ƒæ£€æŸ¥
        run: |
          echo "â”â”â”â”â”â” ç¯å¢ƒä¿¡æ¯ â”â”â”â”â”â”"
          echo "ç£ç›˜ç©ºé—´ï¼š"
          df -h | grep -E '^/dev|Filesystem' || true
          echo ""
          echo "å†…å­˜ä½¿ç”¨ï¼š"
          free -h || true
          echo ""
          echo "ç½‘ç»œè¿é€šæ€§ï¼š"
          curl -s --connect-timeout 5 --max-time 10 -o /dev/null https://www.github.com && echo "âœ… ç½‘ç»œæ­£å¸¸" || echo "âš ï¸  ç½‘ç»œè¿æ¥å¼‚å¸¸"

      - name: å®‰è£…ä¾èµ–
        run: |
          # apt-get update é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
          for i in {1..3}; do
            if sudo apt-get update; then
              break
            elif [[ $i -eq 3 ]]; then
              echo "âŒ apt-get update å¤±è´¥ï¼ˆå·²é‡è¯•3æ¬¡ï¼‰"
              exit 1
            else
              echo "âš ï¸  apt-get update å¤±è´¥ï¼Œç¬¬ $i æ¬¡é‡è¯•..."
              sleep 5
            fi
          done
          
          if ! sudo apt-get install -y curl ca-certificates grep sed coreutils findutils; then
            echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ä¾èµ–å®‰è£…æˆåŠŸ"

      - name: æ£€æŸ¥å¿…è¦æ–‡ä»¶
        run: |
          for file in sources.txt whitelist.txt blacklist.txt; do
            if [[ ! -f "$file" ]]; then
              echo "âŒ $file ä¸å­˜åœ¨"
              exit 1
            fi
            echo "âœ“ $file å­˜åœ¨"
          done

      - name: æ‰§è¡Œè§„åˆ™å¤„ç†ï¼ˆå»é‡åˆå¹¶ï¼‰
        run: |
          if [[ ! -f process.sh ]]; then
            echo "âŒ process.sh æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          if ! chmod +x process.sh; then
            echo "âŒ æ— æ³•è®¾ç½® process.sh æ‰§è¡Œæƒé™"
            exit 1
          fi
          
          rm -f adblock.txt reports.txt README.md
          
          if ! ./process.sh 2>&1 | tee process.log; then
            echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥"
            echo "â”â”â”â”â”â” é”™è¯¯æ—¥å¿—ï¼ˆæœ€å50è¡Œï¼‰â”â”â”â”â”â”"
            tail -n 50 process.log || true
            exit 1
          fi
          
          if [[ ! -f adblock.txt ]] || [[ ! -f reports.txt ]] || [[ ! -f README.md ]]; then
            echo "âŒ ç”Ÿæˆæ–‡ä»¶ç¼ºå¤±"
            ls -la || true
            exit 1
          fi
          
          ls -lh adblock.txt reports.txt README.md
          rm -f process.log
          
          # éªŒè¯æ–‡ä»¶å†…å®¹
          if [[ ! -f adblock.txt ]]; then
            echo "âŒ adblock.txt ä¸å­˜åœ¨"
            exit 1
          fi
          
          line_count=$(wc -l < adblock.txt)
          if [[ $line_count -lt 10 ]]; then
            echo "âŒ adblock.txt å†…å®¹å¼‚å¸¸ï¼ˆå°‘äº10è¡Œï¼Œå®é™… $line_count è¡Œï¼‰"
            exit 1
          fi

      - name: æäº¤æ›´æ–°
        run: |
          set -e
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git config --local core.autocrlf false
          git config --local core.safecrlf false
          
          # ç¡®ä¿åªæäº¤é¢„æœŸæ–‡ä»¶
          git add adblock.txt reports.txt README.md
          
          # éªŒè¯æ–‡ä»¶å·²è¢«æš‚å­˜
          staged_files=$(git diff --cached --name-only | wc -l)
          if [[ $staged_files -eq 0 ]]; then
            echo "âš ï¸  æ²¡æœ‰æ–‡ä»¶è¢«æš‚å­˜ï¼Œå¯èƒ½æ–‡ä»¶æœªå˜æ›´"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æœªè·Ÿè¸ªæ–‡ä»¶
          if [[ -n "$(git status --porcelain | grep '^??' | grep -v 'process.log')" ]]; then
            echo "âš ï¸  æ£€æµ‹åˆ°æœªè·Ÿè¸ªæ–‡ä»¶ï¼š"
            git status --porcelain | grep '^??'
          fi
          
          if git diff --cached --quiet; then
            echo "ğŸ“Œ æ— è§„åˆ™å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          git commit -m "è‡ªåŠ¨æ›´æ–°è§„åˆ™ $(TZ='Asia/Shanghai' date +%Y%m%d_%H%M%S)"
          
          # é‡è¯•æ¨é€æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼Œå¸¦éšæœºå»¶è¿Ÿï¼‰
          for i in {1..3}; do
            if git push origin main; then
              echo "âœ… è§„åˆ™å·²æ›´æ–°å¹¶æ¨é€"
              exit 0
            else
              echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œå°è¯• pull --rebase (ç¬¬ $i æ¬¡)"
              sleep $(( $(date +%N) % 10 ))
              
              if ! git pull --rebase origin main; then
                echo "âŒ Rebase å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨å†²çª"
                git rebase --abort 2>/dev/null || true
                git status
                exit 1
              fi
              
              sleep 2
            fi
          done
          
          echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²é‡è¯•3æ¬¡"
          exit 1
