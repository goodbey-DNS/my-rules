# å¹¿å‘Šæ‹¦æˆªè§„åˆ™è‡ªåŠ¨æ›´æ–°å·¥ä½œæµ
# ç‰ˆæœ¬: 1.0.0
# åŠŸèƒ½: æ¯æ—¥è‡ªåŠ¨ä¸‹è½½ã€å¤„ç†å¹¶æäº¤å¹¿å‘Šæ‹¦æˆªè§„åˆ™
# è§¦å‘æ–¹å¼:
#   1. å®šæ—¶ä»»åŠ¡: æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œ
#   2. æ‰‹åŠ¨è§¦å‘: åœ¨ Actions é¡µé¢ç‚¹å‡» "Run workflow"
# 
# ç”Ÿæˆæ–‡ä»¶: adblock.txt, reports.txt, README.md

name: è§„åˆ™è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥å‡Œæ™¨2ç‚¹
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå·¥ä½œæµè¿è¡Œ
concurrency:
  group: adblock-update
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1
          clean: true

      - name: ç½‘ç»œæºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ~/.cache/adblock-sources
          key: sources-${{ hashFiles('sources.txt', 'process.sh', 'whitelist.txt', 'blacklist.txt') }}
          restore-keys: |
            sources-

      - name: ç¯å¢ƒæ£€æŸ¥
        run: |
          echo "â”â”â”â”â”â” ç¯å¢ƒä¿¡æ¯ â”â”â”â”â”â”"
          echo "ç£ç›˜ç©ºé—´ï¼š"
          df -h | grep -E '^/dev|Filesystem' || true
          
          # æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³ï¼ˆè‡³å°‘1GBå¯ç”¨ï¼‰
          available_kb=$(df . | awk 'NR==2 {print $4}')
          if [[ $available_kb -lt 1048576 ]]; then
            echo "âš ï¸  è­¦å‘Šï¼šç£ç›˜ç©ºé—´ä¸è¶³1GBï¼ˆå¯ç”¨ï¼š$((available_kb / 1024))MBï¼‰"
          else
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³ï¼ˆå¯ç”¨ï¼š$((available_kb / 1024))MBï¼‰"
          fi
          echo ""
          
          echo "å†…å­˜ä½¿ç”¨ï¼š"
          free -h || true
          
          # æ£€æŸ¥å¯ç”¨å†…å­˜æ˜¯å¦å……è¶³ï¼ˆè‡³å°‘500MBï¼‰
          available_mem=$(free -m | awk 'NR==2{print $7}')
          if [[ $available_mem -lt 500 ]]; then
            echo "âš ï¸  è­¦å‘Šï¼šå¯ç”¨å†…å­˜ä¸è¶³500MBï¼ˆå¯ç”¨ï¼š${available_mem}MBï¼‰"
          else
            echo "âœ… å†…å­˜å……è¶³ï¼ˆå¯ç”¨ï¼š${available_mem}MBï¼‰"
          fi
          echo ""
          
          echo "ç½‘ç»œè¿é€šæ€§ï¼š"
          curl -s --connect-timeout 5 --max-time 10 -o /dev/null https://www.github.com && echo "âœ… ç½‘ç»œæ­£å¸¸" || echo "âš ï¸  ç½‘ç»œè¿æ¥å¼‚å¸¸"

      - name: å®‰è£…ä¾èµ–
        run: |
          # apt-get update é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
          for i in {1..3}; do
            if sudo apt-get update; then
              break
            elif [[ $i -eq 3 ]]; then
              echo "âŒ apt-get update å¤±è´¥ï¼ˆå·²é‡è¯•3æ¬¡ï¼‰"
              exit 1
            else
              echo "âš ï¸  apt-get update å¤±è´¥ï¼Œç¬¬ $i æ¬¡é‡è¯•..."
              sleep 5
            fi
          done
          
          # åªå®‰è£…å¯èƒ½ç¼ºå¤±çš„ca-certificatesï¼Œå…¶ä»–éƒ½æ˜¯ç³»ç»Ÿæ ¸å¿ƒåŒ…
          if ! sudo apt-get install -y ca-certificates; then
            echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ä¾èµ–å®‰è£…æˆåŠŸ"

      - name: æ£€æŸ¥å¿…è¦æ–‡ä»¶
        run: |
          for file in sources.txt whitelist.txt blacklist.txt; do
            if [[ ! -f "$file" ]]; then
              echo "âŒ $file ä¸å­˜åœ¨"
              exit 1
            fi
            
            if [[ ! -r "$file" ]]; then
              echo "âŒ $file ä¸å¯è¯»"
              exit 1
            fi
            
            # æ£€æµ‹BOMæ ‡è®°ï¼ˆUTF-8 BOMï¼‰
            if head -c 3 "$file" | grep -q $'\xEF\xBB\xBF'; then
              echo "âš ï¸  $file åŒ…å«UTF-8 BOMæ ‡è®°ï¼ˆå·²è‡ªåŠ¨å¤„ç†ï¼‰"
            fi
            
            # æ£€æŸ¥æ˜¯å¦ä¸ºç©ºæ–‡ä»¶ï¼ˆå…è®¸ä¸ºç©ºï¼Œä½†éœ€æç¤ºï¼‰
            if [[ ! -s "$file" ]]; then
              echo "âš ï¸  $file ä¸ºç©ºæ–‡ä»¶"
            fi
            
            echo "âœ“ $file éªŒè¯é€šè¿‡"
          done

      - name: æ‰§è¡Œè§„åˆ™å¤„ç†ï¼ˆå»é‡åˆå¹¶ï¼‰
        run: |
          if [[ ! -f process.sh ]]; then
            echo "âŒ process.sh æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          if ! chmod +x process.sh; then
            echo "âŒ æ— æ³•è®¾ç½® process.sh æ‰§è¡Œæƒé™"
            exit 1
          fi
          
          # å¥åº·æ£€æŸ¥ï¼šæ¸…ç†å¯èƒ½å­˜åœ¨çš„æŸåæ–‡ä»¶
          rm -f adblock.txt reports.txt README.md
          
          # æ‰§è¡Œå¤„ç†ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨æ¸…ç†ç¼“å­˜å¹¶é‡è¯•ä¸€æ¬¡
          max_attempts=2
          attempt=1
          
          while [[ $attempt -le $max_attempts ]]; do
            echo "æ‰§è¡Œå°è¯• $attempt/$max_attempts..."
            
            if ./process.sh 2>&1 | tee process.log; then
              echo "âœ… ç¬¬ $attempt æ¬¡å°è¯•æˆåŠŸ"
              break
            else
              echo "âŒ ç¬¬ $attempt æ¬¡å°è¯•å¤±è´¥"
              
              if [[ $attempt -lt $max_attempts ]]; then
                echo "ğŸ”„ è‡ªåŠ¨æ¸…ç†å¹¶é‡è¯•..."
                # æ¸…ç†å¯èƒ½æŸåçš„ç¼“å­˜
                rm -rf ~/.cache/adblock-sources/* 2>/dev/null || true
                # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                rm -f .tmp-work-* 2>/dev/null || true
                sleep 5
              else
                echo "â”â”â”â”â”â” é”™è¯¯æ—¥å¿—ï¼ˆæœ€å50è¡Œï¼‰â”â”â”â”â”â”"
                tail -n 50 process.log || true
                exit 1
              fi
            fi
            
            attempt=$((attempt + 1))
          done
          
          if [[ ! -f adblock.txt ]] || [[ ! -f reports.txt ]] || [[ ! -f README.md ]]; then
            echo "âŒ ç”Ÿæˆæ–‡ä»¶ç¼ºå¤±"
            ls -la || true
            exit 1
          fi
          
          ls -lh adblock.txt reports.txt README.md
          
          # éªŒè¯æ–‡ä»¶å†…å®¹
          if [[ ! -f adblock.txt ]]; then
            echo "âŒ adblock.txt ä¸å­˜åœ¨"
            exit 1
          fi
          
          line_count=$(wc -l < adblock.txt)
          if [[ $line_count -lt 10 ]]; then
            echo "âŒ adblock.txt å†…å®¹å¼‚å¸¸ï¼ˆå°‘äº10è¡Œï¼Œå®é™… $line_count è¡Œï¼‰"
            exit 1
          fi
          
          # éªŒè¯å®é™…æœ‰æ•ˆè§„åˆ™æ•°ï¼ˆæ’é™¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰
          valid_rules=$(grep -v '^!' adblock.txt | grep -v '^$' | wc -l)
          if [[ $valid_rules -eq 0 ]]; then
            echo "âŒ adblock.txt ä¸åŒ…å«æœ‰æ•ˆè§„åˆ™"
            exit 1
          fi
          
          echo "âœ… adblock.txt éªŒè¯é€šè¿‡ï¼ˆæ€»è¡Œæ•°: $line_count, æœ‰æ•ˆè§„åˆ™: $valid_rulesï¼‰"

      - name: ç”Ÿæˆè¿è¡Œæ€»ç»“
        if: always()
        run: |
          echo "â”â”â”â”â”â” è¿è¡Œæ€»ç»“ â”â”â”â”â”â”"
          echo "æ—¶é—´ï¼š$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          
          if [[ -f process.log ]]; then
            echo "ğŸ“Š å¤„ç†ç»Ÿè®¡ï¼š"
            grep "æ­¥éª¤" process.log | head -7 || true
            echo ""
            
            echo "ğŸ“ˆ å…³é”®æŒ‡æ ‡ï¼š"
            grep "å¤„ç†ç»Ÿè®¡" process.log || true
            echo ""
            
            if grep -q "æ‰€æœ‰æ­¥éª¤å¤„ç†å®Œæˆ" process.log; then
              echo "âœ… çŠ¶æ€ï¼šæˆåŠŸ"
            else
              echo "âŒ çŠ¶æ€ï¼šå¤±è´¥"
              echo ""
              echo "âš ï¸  æœ€å10è¡Œæ—¥å¿—ï¼š"
              tail -n 10 process.log || true
            fi
          else
            echo "âš ï¸  process.log ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "ğŸ“ æ–‡ä»¶çŠ¶æ€ï¼š"
          ls -lh adblock.txt reports.txt README.md 2>/dev/null || echo "éƒ¨åˆ†æ–‡ä»¶ç¼ºå¤±"

      - name: ä¸Šä¼ æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: process-log
          path: |
            process.log
            .tmp-work-*/filtered-debug.txt
          retention-days: 7

      - name: æäº¤æ›´æ–°
        run: |
          set -e
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git config --local core.autocrlf false
          git config --local core.safecrlf false
          
          # ç¡®ä¿åªæäº¤é¢„æœŸæ–‡ä»¶
          git add adblock.txt reports.txt README.md
          
          # éªŒè¯æ–‡ä»¶å·²è¢«æš‚å­˜
          staged_files=$(git diff --cached --name-only | wc -l)
          if [[ $staged_files -eq 0 ]]; then
            echo "âš ï¸  æ²¡æœ‰æ–‡ä»¶è¢«æš‚å­˜ï¼Œå¯èƒ½æ–‡ä»¶æœªå˜æ›´"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æœªè·Ÿè¸ªæ–‡ä»¶
          if [[ -n "$(git status --porcelain | grep '^??' | grep -v 'process.log')" ]]; then
            echo "âš ï¸  æ£€æµ‹åˆ°æœªè·Ÿè¸ªæ–‡ä»¶ï¼š"
            git status --porcelain | grep '^??'
          fi
          
          if git diff --cached --quiet; then
            echo "ğŸ“Œ æ— è§„åˆ™å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # ä»adblock.txtæå–ç»Ÿè®¡ä¿¡æ¯
          if [[ -f adblock.txt ]]; then
            total_rules=$(grep -c -v '^!' adblock.txt 2>/dev/null || echo 0)
            file_size=$(du -h adblock.txt 2>/dev/null | cut -f1 || echo "0K")
            commit_msg="è‡ªåŠ¨æ›´æ–°è§„åˆ™ $(TZ='Asia/Shanghai' date +%Y%m%d_%H%M%S) | è§„åˆ™æ•°:${total_rules} | å¤§å°:${file_size}"
          else
            commit_msg="è‡ªåŠ¨æ›´æ–°è§„åˆ™ $(TZ='Asia/Shanghai' date +%Y%m%d_%H%M%S)"
          fi
          
          git commit -m "$commit_msg"
          
          # é‡è¯•æ¨é€æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼Œå¸¦éšæœºå»¶è¿Ÿï¼‰
          for i in {1..3}; do
            if git push origin main; then
              echo "âœ… è§„åˆ™å·²æ›´æ–°å¹¶æ¨é€"
              exit 0
            else
              echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œå°è¯• pull --rebase (ç¬¬ $i æ¬¡)"
              sleep $(( RANDOM % 10 ))
              
              if ! git pull --rebase origin main; then
                echo "âŒ Rebase å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨å†²çª"
                git rebase --abort 2>/dev/null || true
                git status
                exit 1
              fi
              
              sleep 2
            fi
          done
          
          echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²é‡è¯•3æ¬¡"
          exit 1
