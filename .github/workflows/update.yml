name: 规则自动更新

on:
  schedule:
    - cron: '0 2 * * *'  # 每天北京时间10点
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v3
        with:
          ref: main
          clean: true

      - name: 网络源缓存
        uses: actions/cache@v3
        with:
          path: ~/.cache/adblock-sources
          key: sources-${{ hashFiles('sources.txt') }}
          restore-keys: |
            sources-

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates parallel

      - name: 执行规则处理
        run: |
          chmod +x scripts/process.sh
          rm -f adblock.txt reports.txt README.md
          ./scripts/process.sh
          ls -lh adblock.txt reports.txt README.md

      - name: 提交更新
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add adblock.txt reports.txt README.md
          git commit -m "自动更新规则 $(date -u +%Y%m%d_%H%M%S)"
          git push origin main
