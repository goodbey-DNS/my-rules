name: è§„åˆ™è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    - cron: '0 18 * * *'  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          ref: main
          clean: true

      - name: ç½‘ç»œæºç¼“å­˜
        uses: actions/cache@v3
        with:
          path: ~/.cache/adblock-sources
          key: sources-${{ hashFiles('sources.txt') }}
          restore-keys: |
            sources-

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates parallel

      - name: æ‰§è¡Œè§„åˆ™å¤„ç†ï¼ˆå»é‡åˆå¹¶ï¼‰
        run: |
          chmod +x process.sh
          rm -f adblock.txt reports.txt README.md
          
          if ! ./process.sh; then
            echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥"
            exit 1
          fi
          
          if [[ ! -f adblock.txt ]] || [[ ! -f reports.txt ]] || [[ ! -f README.md ]]; then
            echo "âŒ ç”Ÿæˆæ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi
          
          ls -lh adblock.txt reports.txt README.md

      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add adblock.txt reports.txt README.md
          
          if git diff --cached --quiet; then
            echo "ğŸ“Œ æ— è§„åˆ™å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          git commit -m "è‡ªåŠ¨æ›´æ–°è§„åˆ™ $(date -u +%Y%m%d_%H%M%S)"
          
          # é‡è¯•æ¨é€æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
          for i in {1..3}; do
            if git push origin main; then
              echo "âœ… è§„åˆ™å·²æ›´æ–°å¹¶æ¨é€"
              exit 0
            else
              echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œå°è¯• pull --rebase (ç¬¬ $i æ¬¡)"
              git pull --rebase origin main
              sleep 2
            fi
          done
          
          echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²é‡è¯•3æ¬¡"
          exit 1
