# å¹¿å‘Šæ‹¦æˆªè§„åˆ™è‡ªåŠ¨æ›´æ–°å·¥ä½œæµ
# ç‰ˆæœ¬: 1.0.0
# åŠŸèƒ½: æ¯æ—¥è‡ªåŠ¨ä¸‹è½½ã€å¤„ç†å¹¶æäº¤å¹¿å‘Šæ‹¦æˆªè§„åˆ™
# è§¦å‘æ–¹å¼:
#   1. å®šæ—¶ä»»åŠ¡: æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œ
#   2. æ‰‹åŠ¨è§¦å‘: åœ¨ Actions é¡µé¢ç‚¹å‡» "Run workflow"
# 
# ç”Ÿæˆæ–‡ä»¶: adblock.txt, reports.txt, README.md

name: è§„åˆ™è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥å‡Œæ™¨2ç‚¹
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå·¥ä½œæµè¿è¡Œ
concurrency:
  group: adblock-update
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1
          clean: true

      - name: ç½‘ç»œæºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.cache/adblock-sources
            logs/
          key: sources-${{ hashFiles('sources.txt', 'whitelist.txt', 'blacklist.txt') }}

      - name: ç¯å¢ƒæ£€æŸ¥
        run: |
          echo "â”â”â”â”â”â” ç¯å¢ƒä¿¡æ¯ â”â”â”â”â”â”"
          echo "ç£ç›˜ç©ºé—´ï¼š"
          df -h | grep -E '^/dev|Filesystem' || true
          
          # æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³ï¼ˆè‡³å°‘1GBå¯ç”¨ï¼‰
          if command -v df >/dev/null 2>&1; then
              available_kb=$(df . 2>/dev/null | tail -n 1 | awk '{print $4}' || echo 1048576)
          else
              available_kb=1048576  # é»˜è®¤å€¼1GB
          fi
          if [[ $available_kb -lt 1048576 ]]; then
            echo "âš ï¸  è­¦å‘Šï¼šç£ç›˜ç©ºé—´ä¸è¶³1GBï¼ˆå¯ç”¨ï¼š$((available_kb / 1024))MBï¼‰"
          else
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³ï¼ˆå¯ç”¨ï¼š$((available_kb / 1024))MBï¼‰"
          fi
          echo ""
          
          echo "å†…å­˜ä½¿ç”¨ï¼š"
          free -h || true
          
          # æ£€æŸ¥å¯ç”¨å†…å­˜æ˜¯å¦å……è¶³ï¼ˆè‡³å°‘500MBï¼‰
          if command -v free >/dev/null 2>&1; then
              available_mem=$(free -m 2>/dev/null | awk 'NR==2{print $7; exit}')
              if [[ -z "$available_mem" || "$available_mem" == "0" ]]; then
                # å¦‚æœæ— æ³•è·å–å¯ç”¨å†…å­˜ï¼Œå°è¯•è®¡ç®—ï¼šavailable = total - used
                available_mem=$(free -m 2>/dev/null | awk 'NR==2{print $2-$3}')
              fi
          else
              available_mem=512  # é»˜è®¤å€¼512MB
          fi
          if [[ $available_mem -lt 500 ]]; then
            echo "âš ï¸  è­¦å‘Šï¼šå¯ç”¨å†…å­˜ä¸è¶³500MBï¼ˆå¯ç”¨ï¼š${available_mem}MBï¼‰"
          else
            echo "âœ… å†…å­˜å……è¶³ï¼ˆå¯ç”¨ï¼š${available_mem}MBï¼‰"
          fi
          echo ""
          
          echo "ç½‘ç»œè¿é€šæ€§ï¼š"
          curl -s --connect-timeout 5 --max-time 10 -o /dev/null https://www.github.com && echo "âœ… ç½‘ç»œæ­£å¸¸" || echo "âš ï¸  ç½‘ç»œè¿æ¥å¼‚å¸¸"
          echo ""
          echo "â”â”â”â”â”â” ç¼“å­˜è·¯å¾„æ£€æŸ¥ â”â”â”â”â”â”"
          CACHE_DIR="$HOME/.cache/adblock-sources"
          echo "HOME ç¯å¢ƒå˜é‡: $HOME"
          echo "ç¼“å­˜ç›®å½•è·¯å¾„: $CACHE_DIR"
          echo "ç¼“å­˜ç›®å½•æ˜¯å¦å­˜åœ¨:"
          ls -la "$CACHE_DIR" 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "ç¼“å­˜ç›®å½•å¤§å°:"
          du -sh "$CACHE_DIR" 2>/dev/null || echo "æ— æ³•è·å–å¤§å°"

      - name: æ‰§è¡Œè§„åˆ™å¤„ç†ï¼ˆå»é‡åˆå¹¶ï¼‰
        run: |
          # æ—¥å¿—è½®è½¬ï¼šä¿ç•™æœ€è¿‘9å¤©çš„æ—¥å¿—æ–‡ä»¶ï¼ˆåˆ é™¤è¶…è¿‡9å¤©çš„ï¼‰
          find logs/ -name "*.log" -mtime +9 -delete 2>/dev/null || true
          
          if [[ ! -f process.sh ]]; then
            echo "âŒ process.sh æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          if ! chmod +x process.sh; then
            echo "âŒ æ— æ³•è®¾ç½® process.sh æ‰§è¡Œæƒé™"
            exit 1
          fi
          
          # å¥åº·æ£€æŸ¥ï¼šæ¸…ç†å¯èƒ½å­˜åœ¨çš„æŸåæ–‡ä»¶
          rm -f adblock.txt reports.txt README.md
          
          # æ‰§è¡Œå¤„ç†ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨æ¸…ç†ç¼“å­˜å¹¶é‡è¯•ä¸€æ¬¡
          max_attempts=2
          
          for attempt in $(seq 1 $max_attempts); do
            echo "æ‰§è¡Œå°è¯• $attempt/$max_attempts..."
            
            # åˆ†ç¦»ç®¡é“ï¼Œä½¿ç”¨PIPESTATUSè·å–çœŸå®é€€å‡ºç 
            ./process.sh 2>&1 | tee process.log
            process_exit_code=${PIPESTATUS[0]}
            
            if [[ $process_exit_code -eq 0 ]]; then
              echo "âœ… ç¬¬ $attempt æ¬¡å°è¯•æˆåŠŸ"
              break
            else
              echo "âŒ ç¬¬ $attempt æ¬¡å°è¯•å¤±è´¥ï¼ˆé€€å‡ºç : $process_exit_codeï¼‰"
              
              if [[ $attempt -lt $max_attempts ]]; then
                echo "ğŸ”„ è‡ªåŠ¨æ¸…ç†å¹¶é‡è¯•..."
                # æ¸…ç†å¯èƒ½æŸåçš„ç¼“å­˜ï¼ˆä¿ç•™æ—¥å¿—æ–‡ä»¶ï¼‰
                find $HOME/.cache/adblock-sources -maxdepth 1 -type f ! -name "*.log" ! -name "*.md5" -delete 2>/dev/null || true
                # æ—¥å¿—è½®è½¬ï¼šä¿ç•™æœ€è¿‘9å¤©çš„æ—¥å¿—æ–‡ä»¶ï¼ˆåˆ é™¤è¶…è¿‡9å¤©çš„ï¼‰
                find logs/ -name "*.log" -mtime +9 -delete 2>/dev/null || true
                # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                rm -f .tmp-work-* 2>/dev/null || true
                sleep 5
                # æ¸…ç†åä¼šç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œè‡ªåŠ¨é‡æ–°è¿è¡Œprocess.sh
              else
                echo "â”â”â”â”â”â” é”™è¯¯æ—¥å¿—ï¼ˆæœ€å50è¡Œï¼‰â”â”â”â”â”â”"
                tail -n 50 process.log || true
                exit 1
              fi
            fi
          done
          
          if [[ ! -f adblock.txt ]] || [[ ! -f reports.txt ]] || [[ ! -f README.md ]]; then
            echo "âŒ ç”Ÿæˆæ–‡ä»¶ç¼ºå¤±"
            ls -la || true
            exit 1
          fi
          
          ls -lh adblock.txt reports.txt README.md
          
          # éªŒè¯æ–‡ä»¶å†…å®¹
          if [[ ! -f adblock.txt ]]; then
            echo "âŒ adblock.txt ä¸å­˜åœ¨"
            exit 1
          fi
          
          line_count=$(wc -l < adblock.txt)
          if [[ $line_count -lt 1 ]]; then
            echo "âŒ adblock.txt å†…å®¹å¼‚å¸¸ï¼ˆæ–‡ä»¶ä¸ºç©ºï¼‰"
            exit 1
          fi
          
          # è¡Œæ•°è¾ƒå°‘æ—¶æ·»åŠ è­¦å‘Šï¼ˆä¸å½±å“æ‰§è¡Œï¼‰
          if [[ $line_count -lt 10 ]]; then
            echo "âš ï¸  è­¦å‘Šï¼šadblock.txt è¡Œæ•°è¾ƒå°‘ï¼ˆ$line_count è¡Œï¼‰ï¼Œè¯·æ£€æŸ¥è§„åˆ™æº"
          fi
          
          # éªŒè¯å®é™…æœ‰æ•ˆè§„åˆ™æ•°ï¼ˆæ’é™¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰
          valid_rules=$(grep -v '^!' adblock.txt | grep -v '^$' | wc -l)
          if [[ $valid_rules -eq 0 ]]; then
            echo "âŒ adblock.txt ä¸åŒ…å«æœ‰æ•ˆè§„åˆ™"
            exit 1
          fi
          
          echo "âœ… adblock.txt éªŒè¯é€šè¿‡ï¼ˆæ€»è¡Œæ•°: $line_count, æœ‰æ•ˆè§„åˆ™: $valid_rulesï¼‰"

      - name: ç”Ÿæˆè¿è¡Œæ€»ç»“
        if: always()
        run: |
          echo "â”â”â”â”â”â” è¿è¡Œæ€»ç»“ â”â”â”â”â”â”"
          # å°è¯•ä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨UTC
          beijing_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S' 2>/dev/null || date -u '+%Y-%m-%d %H:%M:%S (UTC)')
          echo "æ—¶é—´ï¼š$beijing_time"
          echo ""
          
          if [[ -f process.log ]]; then
            echo "ğŸ“Š å¤„ç†ç»Ÿè®¡ï¼š"
            grep "æ­¥éª¤" process.log | head -7 || true
            echo ""
            
            echo "ğŸ“ˆ å…³é”®æŒ‡æ ‡ï¼š"
            grep "å¤„ç†ç»Ÿè®¡" process.log || true
            echo ""
            
            if grep -q "æ‰€æœ‰æ­¥éª¤å¤„ç†å®Œæˆ" process.log; then
              echo "âœ… çŠ¶æ€ï¼šæˆåŠŸ"
            else
              echo "âŒ çŠ¶æ€ï¼šå¤±è´¥"
              echo ""
              echo "âš ï¸  æœ€å10è¡Œæ—¥å¿—ï¼š"
              tail -n 10 process.log || true
            fi
          else
            echo "âš ï¸  process.log ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "ğŸ“ æ–‡ä»¶çŠ¶æ€ï¼š"
          ls -lh adblock.txt reports.txt README.md 2>/dev/null || echo "éƒ¨åˆ†æ–‡ä»¶ç¼ºå¤±"

      - name: ä¸Šä¼ æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: process-log
          path: process.log
          retention-days: 7

      - name: æäº¤æ›´æ–°
        run: |
          set -e
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git config --local core.autocrlf false
          git config --local core.safecrlf false
          
          # ç¡®ä¿åªæäº¤é¢„æœŸæ–‡ä»¶
          git add adblock.txt reports.txt README.md
          
          # éªŒè¯æ–‡ä»¶å·²è¢«æš‚å­˜
          staged_files=$(git diff --cached --name-only | wc -l)
          if [[ $staged_files -eq 0 ]]; then
            echo "âš ï¸  æ²¡æœ‰æ–‡ä»¶è¢«æš‚å­˜ï¼Œå¯èƒ½æ–‡ä»¶æœªå˜æ›´"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æœªè·Ÿè¸ªæ–‡ä»¶
          if [[ -n "$(git status --porcelain | grep '^??' | grep -v 'process.log')" ]]; then
            echo "âš ï¸  æ£€æµ‹åˆ°æœªè·Ÿè¸ªæ–‡ä»¶ï¼š"
            git status --porcelain | grep '^??'
          fi
          
          if git diff --cached --quiet; then
            echo "ğŸ“Œ æ— è§„åˆ™å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # ä»adblock.txtæå–ç»Ÿè®¡ä¿¡æ¯
          if [[ -f adblock.txt ]]; then
            total_rules=$(grep -c -v '^!' adblock.txt 2>/dev/null || echo 0)
            file_size=$(du -h adblock.txt 2>/dev/null | cut -f1 || echo "0K")
            # å°è¯•ä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨UTC
            timestamp=$(TZ='Asia/Shanghai' date +%Y%m%d_%H%M%S 2>/dev/null || date -u +%Y%m%d_%H%M%S)
            commit_msg="è‡ªåŠ¨æ›´æ–°è§„åˆ™ ${timestamp} | è§„åˆ™æ•°:${total_rules} | å¤§å°:${file_size}"
          else
            timestamp=$(TZ='Asia/Shanghai' date +%Y%m%d_%H%M%S 2>/dev/null || date -u +%Y%m%d_%H%M%S)
            commit_msg="è‡ªåŠ¨æ›´æ–°è§„åˆ™ ${timestamp}"
          fi
          
          git commit -m "$commit_msg"
          
          # é‡è¯•æ¨é€æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼Œå¸¦éšæœºå»¶è¿Ÿï¼‰
          retry_count=0
          max_retries=3
          
          while [[ $retry_count -lt $max_retries ]]; do
            if git push origin main; then
              echo "âœ… è§„åˆ™å·²æ›´æ–°å¹¶æ¨é€"
              break
            else
              ((retry_count++))
              
              if [[ $retry_count -lt $max_retries ]]; then
                echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œå°è¯• pull --rebase (ç¬¬ $retry_count/$max_retries æ¬¡)"
                sleep $((RANDOM % 10))
                
                if ! git pull --rebase origin main; then
                  echo "âŒ Rebase å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨å†²çª"
                  git rebase --abort 2>/dev/null || true
                  git status
                  exit 1
                fi
                
                sleep 2
              else
                echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²é‡è¯•$max_retriesæ¬¡"
                exit 1
              fi
            fi
          done
